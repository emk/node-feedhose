<html>
  <head>
    <title>Feed Nozzle</title>
    <link rel="stylesheet" type="text/css" href="/feed.css" />
  </head>
  <body>
    <h1>Feed Nozzle</h1>
    
    <p id="connecting">Connecting to feedhose...</p>
      
    <div id="hose">
    </div>

    <!-- Let Google pay to host jQuery for us.  Scripts are at the bottom
         to improve page load speed. -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>

    <!-- This is required to make socket.io work. -->
    <script type="text/javascript" src="/json2.js"></script>

    <!-- Use socket.io to do highly portable long polling, websockets, etc.:
         Whatever will be fastest for a given browser. -->
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>

    <!-- Sanitize HTML so nobody sneaks in script tags and pwns us. -->
    <script type="text/javascript" src="/html-sanitizer.js"></script>

    <!-- Primitive HTML template support. -->
    <script type="text/javascript" src="/microtemplating.js"></script>

    <!-- HTML template for an RSS item. -->
    <script id="item_tmpl" type="text/html">
      <div class="item">
        <h3>
          <a href="<%= to_html(link) %>"><%= html_sanitize(title) %></a>
          <span class="feed_name">(<a href="<%= to_html(feedLink) %>"><%= to_html(feedTitle) %></a>)</span>
        </h3>
        <div class="description">
          <%= html_sanitize(description) %>
        </div>
      </div>
    </script>

    <!-- The actual code. -->
    <script type="text/javascript">

// Convert a string to HTML.
this.to_html = function (str) {
  return str.replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

// Get the current time, in milliseconds.
function getTime() {
  return new Date().getTime();
}

function connectToServer() {
  var connected_at;
  var socket = new io.Socket();
  socket.connect();
  socket.on('connect', function () {
    $('#connecting').hide();
    connected_at = getTime();
  });
  socket.on('message', function (item) {
    // If our connection is more than 5 seconds old, don't animate anything.
    var html = $(tmpl('item_tmpl', item));
    if (getTime() - connected_at < 5000) {
      html.prependTo('#hose');
    } else {
      $('.item').stop(true, true);
      $(tmpl('item_tmpl', item)).hide().prependTo('#hose').slideDown();
    }
  });
  socket.on('disconnect', reconnect);
}

// Schedule a reconnection attempt shortly.  Note that this function
// does not currently get called if a connection attempt fails.
function reconnect() {
    setTimeout(connectToServer, 5000);
}

// Ask jQuery to run this code once the page is fully loaded.
$(connectToServer);
    </script>
  </body>
</html>
