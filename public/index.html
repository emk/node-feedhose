<html>
  <head>
    <title>Feed Hose: Read NYT headlines in real time</title>
    <link rel="stylesheet" type="text/css" href="/feed.css" />
  </head>
  <body>
    <h1>Feed Hose: Read NYT headlines in real time</h1>
    
    <p>
      [About this site:
      <a href="http://scripting.com/stories/2010/09/30/feedhoseAFirehoseForFeeds.html">Feedhose protocol</a> |
      <a href="http://scripting.com/stories/2010/09/30/feedhoseAFirehoseForFeeds.html">Feedhose JSON protocol</a> |
      <a href="http://github.com/emk/node-feedhose">Client source code</a> |
      <a href="http://github.com/emk/node-feedhose/issues">Report a bug</a> |
      <a href="http://www.randomhacks.net/contact">Contact the author</a> ]
    </p>

    <p id="connecting">Connecting to feedhose...</p>

    <p id="disconnected" style="display: none">Lost connection.  Will try
    again in a bit, but feel free to reload.</p>
      
    <div id="hose">
    </div>

    <!-- Let Google pay to host jQuery for us.  Scripts are at the bottom
         to improve page load speed. -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>

    <!-- This is required to make socket.io work. -->
    <script type="text/javascript" src="/json2.js"></script>

    <!-- Use socket.io to do highly portable long polling, websockets, etc.:
         Whatever will be fastest for a given browser. -->
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>

    <!-- Sanitize HTML so nobody sneaks in script tags and pwns us. -->
    <script type="text/javascript" src="/html-sanitizer.js"></script>

    <!-- Primitive HTML template support. -->
    <script type="text/javascript" src="/microtemplating.js"></script>

    <!-- HTML template for an RSS item. -->
    <script id="item_tmpl" type="text/html">
      <div class="item">
        <h3>
          <a href="<%= to_html(link) %>"><%= html_sanitize(title) %></a>
          <span class="feed_name">(<a href="<%= to_html(feedLink) %>"><%= to_html(feedTitle) %></a> @ <%= to_html(pubDate) %>)</span>
        </h3>
        <div class="description">
          <%= html_sanitize(description) %>
        </div>
      </div>
    </script>

    <!-- The actual code. -->
    <script type="text/javascript">

// Convert a string to HTML.
this.to_html = function (str) {
  return str.replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

// Get the current time, in milliseconds.
function getTime() {
  return new Date().getTime();
}

// The GUIDs for all the items we've seen so far.  This allows us to
// suppress duplicates.
var guids = {};

// Get the GUID of an RSS item.  If we want to handle feeds without
// GUIDs, then we could fall back to links and titles here.
function itemGuid(item) {
  return item['guid']['#value'];
}

// Render an item, and optionally animate its appearance on the page.
function renderItem(item, animate) {
  // Have we already rendered this item?  If so, bail.
  var guid = itemGuid(item);
  if (guids[guid])
    return;

  // Render our item as HTML, and optionally animate it into place.
  var html = $(tmpl('item_tmpl', item));
  if (animate) {
    html.prependTo('#hose');
  } else {
    $('.item').stop(true, true); // Finish existing animations now.
    $(tmpl('item_tmpl', item)).hide().prependTo('#hose').slideDown();
  }
}

// Connect to the server, and handle our responses.
function connectToServer() {
  $('#disconnected').hide();
  $('#connecting').show();
  var connected_at;
  var socket = new io.Socket();
  socket.connect();
  socket.on('connect', function () {
    $('#connecting').hide();
    connected_at = getTime();
  });
  socket.on('message', function (item) {
    // If our connection is more than 5 seconds old, don't animate anything.
    // Otherwise, do a slide animation.
    renderItem(item, getTime() - connected_at < 5000);
  });
  socket.on('disconnect', reconnect);
}

// Schedule a reconnection attempt shortly.  Note that this function
// does not currently get called if a connection attempt fails.
function reconnect() {
  $('#disconnected').show();
  setTimeout(connectToServer, 30*1000);
}

// Ask jQuery to run this code once the page is fully loaded.
$(connectToServer);
    </script>
  </body>
</html>
